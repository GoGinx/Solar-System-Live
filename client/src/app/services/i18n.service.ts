import { Injectable } from '@angular/core';
import { BehaviorSubject } from 'rxjs';

export type Language = 'fr' | 'en';

const STORAGE_KEY = 'solar-system-language';

const TRANSLATIONS: Record<Language, Record<string, string>> = {
  fr: {
    'nav.label': 'Navigation',
    'nav.solar': 'Systeme solaire',
    'nav.voyager1': 'Voyager 1',
    'nav.voyager2': 'Voyager 2',
    'nav.toggleLanguage': 'Basculer la langue',
    'nav.language': 'FR',
    'aria.solarMap': 'Carte du systeme solaire (live)',
    'aria.orbits': 'Orbites',
    'aria.planets': 'Planetes',
    'aria.satellites': 'Satellites',
    'aria.voyagerMap': 'Carte Voyager',
    'aria.scale': 'Echelle',
    'aria.timeScrubber': 'Curseur temps (1 an)',
    'aria.timeOffset': 'Decalage temporel (annees)',
    'label.now': 'MAINT',
    'label.nowShort': 'NOW',
    'label.timeRange': '1 AN',
    'label.syntheticPosition': 'Position synthetique',
    'label.timeScaleYears': 'Echelle (annees)',
    'label.timeScale30Years': 'Echelle (x30 ans)',
    'label.live': 'LIVE',
    'label.syncShort': 'sync...',
    'label.syncLong': 'Synchronisation des ephemerides...',
    'label.kind.planet': 'Planete',
    'label.kind.moon': 'Satellite',
    'label.kind.star': 'Etoile',
    'label.catalog': 'Catalogue',
    'label.ephemeris': 'Ephemerides (live)',
    'label.radius': 'Rayon moyen',
    'label.mass': 'Masse',
    'label.meanTemp': 'Temperature moyenne',
    'label.meanDensity': 'Densite moyenne',
    'label.gravity': 'Gravite surface',
    'label.escapeVelocity': 'Vitesse liberation',
    'label.category': 'Categorie',
    'label.semiMajorAxis': 'Demi-grand axe',
    'label.orbitalPeriod': 'Periode orbitale',
    'label.rotationPeriod': 'Periode rotation',
    'label.inclination': 'Inclinaison orbitale',
    'label.axialTilt': 'Obliquite',
    'label.eccentricity': 'Excentricite',
    'label.moonsCount': 'Satellites (nb)',
    'label.majorMoons': 'Satellites majeurs',
    'label.rings': 'Anneaux',
    'label.parentPlanet': 'Planete parente',
    'label.horizonsId': 'ID Horizons',
    'label.reference': 'Reference',
    'label.source': 'Source',
    'label.referenceFrame': 'Reference',
    'label.distanceHelio': 'Distance heliocentrique',
    'label.distanceEarth': 'Distance a la Terre',
    'label.distanceSun': 'Distance Soleil',
    'label.distanceSunKm': 'Distance Soleil (km)',
    'label.distanceSunMiles': 'Distance Soleil (miles)',
    'label.distanceEarthKm': 'Distance Terre (km)',
    'label.distanceEarthMiles': 'Distance Terre (miles)',
    'label.rangeRate': 'Vitesse radiale (geo)',
    'label.lightTime': 'Temps lumiere (aller)',
    'label.lightTimeOneWay': 'Temps lumiere (1 sens)',
    'label.lightTimeTwoWay': 'Temps lumiere (AR)',
    'label.solarElongation': 'Elongation Soleil-Obs-Obj',
    'label.phaseAngle': 'Angle de phase',
    'label.illumination': 'Fraction eclairee',
    'label.apparentMagnitude': 'Magnitude apparente',
    'label.speedVector': 'Vitesse (vecteur)',
    'label.speed': 'Vitesse',
    'label.speedAuPerDay': 'Vitesse (AU/j)',
    'label.speedMilesPerS': 'Vitesse (miles/s)',
    'label.subsolarLat': 'Latitude subsolaire',
    'label.northPole': 'Pole nord',
    'label.southPole': 'Pole sud',
    'label.coordsAu': 'Coordonnees (AU)',
    'label.positionXAu': 'Position X (AU)',
    'label.positionYAu': 'Position Y (AU)',
    'label.positionZAu': 'Position Z (AU)',
    'label.positionXKm': 'Position X (km)',
    'label.positionYKm': 'Position Y (km)',
    'label.positionZKm': 'Position Z (km)',
    'label.vxAuDay': 'Vitesse VX (AU/j)',
    'label.vyAuDay': 'Vitesse VY (AU/j)',
    'label.vzAuDay': 'Vitesse VZ (AU/j)',
    'label.vxKmS': 'Vitesse VX (km/s)',
    'label.vyKmS': 'Vitesse VY (km/s)',
    'label.vzKmS': 'Vitesse VZ (km/s)',
    'label.eclipticLonLat': 'Lon/Lat ecliptique',
    'label.velocityAzimuth': 'Cap vitesse (azimut)',
    'label.velocityLat': 'Cap vitesse (latitude)',
    'label.galaxy': 'Galaxie',
    'label.scale': 'Echelle',
    'label.type': 'Type',
    'label.angle': 'Angle',
    'label.distanceAu': 'Distance (AU)',
    'label.outOfScale': 'Hors echelle',
    'label.detailsMore': 'Voir details',
    'label.detailsLess': 'Masquer details',
    'label.detailsShort': 'Version courte',
    'label.detailsLong': 'Version detaillee',
    'label.missionFacts': 'Infos mission',
    'label.launchDate': 'Lancement',
    'label.flybys': 'Survols',
    'label.status': 'Statut',
    'label.heliopauseDelta': 'Heliopause',
    'label.heliopauseLy': 'Heliopause (a.l.)',
    'label.beyondHeliopause': 'au-dela',
    'label.insideHeliopause': 'en-deca',
    'label.instruments': 'Instruments',
    'label.heliopause': 'Heliopause',
    'label.signalDelay': 'Temps signal',
    'label.distanceGraph': 'Distance (12 mois)',
    'label.graphRange': '12 derniers mois',
    'label.compareOn': 'Afficher comparaison',
    'label.compareOff': 'Masquer comparaison',
    'label.graphLegendMain': 'Courbe principale',
    'label.graphLegendOther': 'Pointillee = autre',
    'label.links': 'Liens',
    'label.nasa': 'NASA',
    'label.jpl': 'JPL',
    'value.lit': 'eclaire',
    'value.dark': 'nuit',
    'value.yes': 'Oui',
    'value.no': 'Non',
    'months.short': 'Ja,Fe,Ma,Av,Ma,Jn,Jl,Ao,Se,Oc,No,De',
    'unit.yearShort': 'an',
    'unit.thirtyYearsShort': 'x30 ans',
    'name.sun': 'Soleil',
    'name.mercury': 'Mercure',
    'name.venus': 'Venus',
    'name.earth': 'Terre',
    'name.mars': 'Mars',
    'name.jupiter': 'Jupiter',
    'name.saturn': 'Saturne',
    'name.uranus': 'Uranus',
    'name.neptune': 'Neptune',
    'name.pluto': 'Pluton',
    'instrument.magnetometer': 'Magnetometre (MAG)',
    'instrument.plasma': 'Plasma (PLS)',
    'instrument.cosmicRays': 'Rayons cosmiques (CRS)',
    'instrument.plasmaWaves': 'Ondes plasma (PWS)',
    'instrument.magnetometer.short': 'Champ magnetique',
    'instrument.plasma.short': 'Plasma solaire',
    'instrument.cosmicRays.short': 'Particules energiques',
    'instrument.plasmaWaves.short': 'Ondes radio-plasma',
    'tick.start': 'T-1an',
    'tick.now': 'Maintenant',
    'context.kuiper.title': 'Ceinture de Kuiper',
    'context.kuiper.short': "Zone d'objets transneptuniens (~30-50 UA).",
    'context.kuiper.long': 'Region au-dela de Neptune contenant de nombreux petits corps (objets transneptuniens).',
    'context.heliopause.title': 'Heliopause',
    'context.heliopause.short': 'Frontiere approximative du vent solaire (~120 UA).',
    'context.heliopause.long': "Zone ou l'influence du vent solaire s'equilibre avec le milieu interstellaire.",
    'context.oort.title': "Nuage d'Oort",
    'context.oort.short': "Reservoir theorique de cometes (jusqu'a ~100k UA).",
    'context.oort.long': 'Structure hypothetique tres lointaine, source possible de cometes a longue periode.',
    'context.proxima.title': 'Proxima Centauri',
    'context.proxima.short': 'Etoile la plus proche (~4.24 a.l.).',
    'context.proxima.long': "Naine rouge, membre du systeme Alpha Centauri. Distance indiquee a l'echelle radiale (ordre de grandeur).",
    'context.alpha.title': 'Alpha Centauri',
    'context.alpha.short': 'Systeme stellaire proche (~4.37 a.l.).',
    'context.alpha.long': "Systeme binaire (A/B) + Proxima. Distance indiquee a l'echelle radiale (ordre de grandeur).",
    'context.milky.title': 'Voie lactee',
    'context.milky.short': 'Notre galaxie (contexte).',
    'context.milky.long': 'Voyager 1 et 2 sont toujours dans la Voie lactee. Les galaxies sont affichees hors echelle.',
    'context.andromeda.title': 'Andromede',
    'context.andromeda.short': 'Galaxie voisine (~2.5 M a.l., hors echelle).',
    'context.andromeda.long': "Destination symbolique uniquement : a ces vitesses, une traversee vers une autre galaxie depasserait de tres loin l'echelle humaine.",
    'voyager.details': 'Voyager reste dans la Voie lactee : la "destination galaxie" est un repere symbolique. Les valeurs proviennent de NASA JPL Horizons.',
    'status.voyager.interstellar': 'Interstellaire'
  },
  en: {
    'nav.label': 'Navigation',
    'nav.solar': 'Solar system',
    'nav.voyager1': 'Voyager 1',
    'nav.voyager2': 'Voyager 2',
    'nav.toggleLanguage': 'Toggle language',
    'nav.language': 'EN',
    'aria.solarMap': 'Solar system map (live)',
    'aria.orbits': 'Orbits',
    'aria.planets': 'Planets',
    'aria.satellites': 'Satellites',
    'aria.voyagerMap': 'Voyager map',
    'aria.scale': 'Scale',
    'aria.timeScrubber': 'Time scrubber (1 year)',
    'aria.timeOffset': 'Time offset (years)',
    'label.now': 'NOW',
    'label.nowShort': 'NOW',
    'label.timeRange': '1 YR',
    'label.syntheticPosition': 'Synthetic position',
    'label.timeScaleYears': 'Time scale (years)',
    'label.timeScale30Years': 'Time scale (x30 yr)',
    'label.live': 'LIVE',
    'label.syncShort': 'sync...',
    'label.syncLong': 'Synchronizing ephemeris...',
    'label.kind.planet': 'Planet',
    'label.kind.moon': 'Moon',
    'label.kind.star': 'Star',
    'label.catalog': 'Catalog',
    'label.ephemeris': 'Ephemeris (live)',
    'label.radius': 'Mean radius',
    'label.mass': 'Mass',
    'label.meanTemp': 'Mean temperature',
    'label.meanDensity': 'Mean density',
    'label.gravity': 'Surface gravity',
    'label.escapeVelocity': 'Escape velocity',
    'label.category': 'Category',
    'label.semiMajorAxis': 'Semi-major axis',
    'label.orbitalPeriod': 'Orbital period',
    'label.rotationPeriod': 'Rotation period',
    'label.inclination': 'Orbital inclination',
    'label.axialTilt': 'Axial tilt',
    'label.eccentricity': 'Eccentricity',
    'label.moonsCount': 'Moons (count)',
    'label.majorMoons': 'Major moons',
    'label.rings': 'Rings',
    'label.parentPlanet': 'Parent planet',
    'label.horizonsId': 'Horizons ID',
    'label.reference': 'Reference',
    'label.source': 'Source',
    'label.referenceFrame': 'Reference',
    'label.distanceHelio': 'Heliocentric distance',
    'label.distanceEarth': 'Distance to Earth',
    'label.distanceSun': 'Distance to Sun',
    'label.distanceSunKm': 'Distance to Sun (km)',
    'label.distanceSunMiles': 'Distance to Sun (miles)',
    'label.distanceEarthKm': 'Distance to Earth (km)',
    'label.distanceEarthMiles': 'Distance to Earth (miles)',
    'label.rangeRate': 'Radial speed (geo)',
    'label.lightTime': 'Light time (one-way)',
    'label.lightTimeOneWay': 'Light time (one-way)',
    'label.lightTimeTwoWay': 'Light time (round-trip)',
    'label.solarElongation': 'Solar elongation',
    'label.phaseAngle': 'Phase angle',
    'label.illumination': 'Illuminated fraction',
    'label.apparentMagnitude': 'Apparent magnitude',
    'label.speedVector': 'Speed (vector)',
    'label.speed': 'Speed',
    'label.speedAuPerDay': 'Speed (AU/day)',
    'label.speedMilesPerS': 'Speed (miles/s)',
    'label.subsolarLat': 'Subsolar latitude',
    'label.northPole': 'North pole',
    'label.southPole': 'South pole',
    'label.coordsAu': 'Coordinates (AU)',
    'label.positionXAu': 'Position X (AU)',
    'label.positionYAu': 'Position Y (AU)',
    'label.positionZAu': 'Position Z (AU)',
    'label.positionXKm': 'Position X (km)',
    'label.positionYKm': 'Position Y (km)',
    'label.positionZKm': 'Position Z (km)',
    'label.vxAuDay': 'Velocity VX (AU/day)',
    'label.vyAuDay': 'Velocity VY (AU/day)',
    'label.vzAuDay': 'Velocity VZ (AU/day)',
    'label.vxKmS': 'Velocity VX (km/s)',
    'label.vyKmS': 'Velocity VY (km/s)',
    'label.vzKmS': 'Velocity VZ (km/s)',
    'label.eclipticLonLat': 'Ecliptic lon/lat',
    'label.velocityAzimuth': 'Velocity heading (azimuth)',
    'label.velocityLat': 'Velocity heading (latitude)',
    'label.galaxy': 'Galaxy',
    'label.scale': 'Scale',
    'label.type': 'Type',
    'label.angle': 'Angle',
    'label.distanceAu': 'Distance (AU)',
    'label.outOfScale': 'Not to scale',
    'label.detailsMore': 'Show details',
    'label.detailsLess': 'Hide details',
    'label.detailsShort': 'Short version',
    'label.detailsLong': 'Detailed version',
    'label.missionFacts': 'Mission facts',
    'label.launchDate': 'Launch',
    'label.flybys': 'Flybys',
    'label.status': 'Status',
    'label.heliopauseDelta': 'Heliopause',
    'label.heliopauseLy': 'Heliopause (ly)',
    'label.beyondHeliopause': 'beyond',
    'label.insideHeliopause': 'inside',
    'label.instruments': 'Instruments',
    'label.heliopause': 'Heliopause',
    'label.signalDelay': 'Signal delay',
    'label.distanceGraph': 'Distance (12 months)',
    'label.graphRange': 'Last 12 months',
    'label.compareOn': 'Show comparison',
    'label.compareOff': 'Hide comparison',
    'label.graphLegendMain': 'Main curve',
    'label.graphLegendOther': 'Dashed = other',
    'label.links': 'Links',
    'label.nasa': 'NASA',
    'label.jpl': 'JPL',
    'value.lit': 'lit',
    'value.dark': 'dark',
    'value.yes': 'Yes',
    'value.no': 'No',
    'months.short': 'Ja,Fe,Ma,Ap,My,Jn,Jl,Au,Se,Oc,No,De',
    'unit.yearShort': 'yr',
    'unit.thirtyYearsShort': 'x30 yr',
    'name.sun': 'Sun',
    'name.mercury': 'Mercury',
    'name.venus': 'Venus',
    'name.earth': 'Earth',
    'name.mars': 'Mars',
    'name.jupiter': 'Jupiter',
    'name.saturn': 'Saturn',
    'name.uranus': 'Uranus',
    'name.neptune': 'Neptune',
    'name.pluto': 'Pluto',
    'instrument.magnetometer': 'Magnetometer (MAG)',
    'instrument.plasma': 'Plasma (PLS)',
    'instrument.cosmicRays': 'Cosmic rays (CRS)',
    'instrument.plasmaWaves': 'Plasma waves (PWS)',
    'instrument.magnetometer.short': 'Magnetic field',
    'instrument.plasma.short': 'Solar plasma',
    'instrument.cosmicRays.short': 'Energetic particles',
    'instrument.plasmaWaves.short': 'Radio plasma waves',
    'tick.start': 'T-1yr',
    'tick.now': 'Now',
    'context.kuiper.title': 'Kuiper Belt',
    'context.kuiper.short': 'Trans-Neptunian objects region (~30-50 AU).',
    'context.kuiper.long': 'Region beyond Neptune containing many small bodies (trans-Neptunian objects).',
    'context.heliopause.title': 'Heliopause',
    'context.heliopause.short': 'Approximate solar wind boundary (~120 AU).',
    'context.heliopause.long': 'Zone where solar wind pressure balances the interstellar medium.',
    'context.oort.title': 'Oort Cloud',
    'context.oort.short': 'Theoretical comet reservoir (up to ~100k AU).',
    'context.oort.long': 'Hypothetical distant structure, potential source of long-period comets.',
    'context.proxima.title': 'Proxima Centauri',
    'context.proxima.short': 'Nearest star (~4.24 ly).',
    'context.proxima.long': 'Red dwarf, member of Alpha Centauri system. Distance shown on radial scale.',
    'context.alpha.title': 'Alpha Centauri',
    'context.alpha.short': 'Nearby stellar system (~4.37 ly).',
    'context.alpha.long': 'Binary system (A/B) + Proxima. Distance shown on radial scale.',
    'context.milky.title': 'Milky Way',
    'context.milky.short': 'Our galaxy (context).',
    'context.milky.long': 'Voyager 1 and 2 are still in the Milky Way. Galaxies are not to scale.',
    'context.andromeda.title': 'Andromeda',
    'context.andromeda.short': 'Neighbor galaxy (~2.5 M ly, not to scale).',
    'context.andromeda.long': 'Symbolic destination only: at these speeds, a trip to another galaxy is far beyond human timescales.',
    'voyager.details': 'Voyager remains in the Milky Way: the "galaxy destination" is only symbolic. Values come from NASA JPL Horizons.',
    'status.voyager.interstellar': 'Interstellar mission'
  }
};

@Injectable({ providedIn: 'root' })
export class I18nService {
  private readonly langSubject = new BehaviorSubject<Language>(this.loadInitial());
  readonly lang$ = this.langSubject.asObservable();

  get language(): Language {
    return this.langSubject.value;
  }

  setLanguage(lang: Language): void {
    if (lang === this.langSubject.value) return;
    this.langSubject.next(lang);
    if (typeof localStorage !== 'undefined') {
      localStorage.setItem(STORAGE_KEY, lang);
    }
  }

  toggleLanguage(): Language {
    const next: Language = this.language === 'fr' ? 'en' : 'fr';
    this.setLanguage(next);
    return next;
  }

  t(key: string): string {
    return TRANSLATIONS[this.language][key] ?? TRANSLATIONS.en[key] ?? key;
  }

  private loadInitial(): Language {
    if (typeof localStorage !== 'undefined') {
      const stored = localStorage.getItem(STORAGE_KEY);
      if (stored === 'fr' || stored === 'en') return stored;
    }
    if (typeof navigator !== 'undefined') {
      const lang = navigator.language?.toLowerCase() ?? '';
      if (lang.startsWith('fr')) return 'fr';
    }
    return 'en';
  }
}
