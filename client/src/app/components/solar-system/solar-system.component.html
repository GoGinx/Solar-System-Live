<div class="space-stage" [style.--selected-planet-scale]="selectedPlanetScale">
  <svg
    class="solar-system-svg"
    [attr.width]="width"
    [attr.height]="height"
    [attr.viewBox]="'0 0 ' + width + ' ' + height"
    role="img"
    [attr.aria-label]="'aria.solarMap' | t"
  >
    <defs>
      <radialGradient id="sunGradient">
        <stop offset="0%" stop-color="#ffffdd" />
        <stop offset="70%" stop-color="#ffcc33" />
        <stop offset="100%" stop-color="#dd8800" />
      </radialGradient>

      <!-- Per-planet shading (day/night) -->
      <radialGradient
        *ngFor="let dp of displayPlanets; trackBy: trackByPlanetName"
        [attr.id]="'planetGrad-' + dp.planet.name"
        cx="50%"
        cy="50%"
        r="80%"
        [attr.fx]="dp.gradFx"
        [attr.fy]="dp.gradFy"
      >
        <stop offset="0%" [attr.stop-color]="dp.lightColor" stop-opacity="1" />
        <stop offset="52%" [attr.stop-color]="dp.baseColor" stop-opacity="1" />
        <stop offset="78%" [attr.stop-color]="dp.planet.color" stop-opacity="1" />
        <stop offset="100%" [attr.stop-color]="dp.darkColor" stop-opacity="1" />
      </radialGradient>

      <!-- Per-planet textures (rotating) -->
      <pattern
        *ngFor="let dp of displayPlanets; trackBy: trackByPlanetName"
        [attr.id]="'planetTex-' + dp.planet.name"
        patternUnits="objectBoundingBox"
        patternContentUnits="objectBoundingBox"
        width="1"
        height="1"
        [attr.patternTransform]="'rotate(' + dp.textureRotationDeg + ' 0.5 0.5)'"
      >
        <image
          x="0"
          y="0"
          width="1"
          height="1"
          preserveAspectRatio="xMidYMid slice"
          [attr.href]="dp.textureUrl"
          [attr.xlink:href]="dp.textureUrl"
        />
      </pattern>
    </defs>

    <!-- Sun (center) -->
    <circle
      [attr.cx]="centerX"
      [attr.cy]="centerY"
      [attr.r]="14"
      fill="url(#sunGradient)"
      class="sun sun-clickable"
      (click)="onSunClick(); $event.stopPropagation()"
    ></circle>
    <circle
      [attr.cx]="centerX"
      [attr.cy]="centerY"
      [attr.r]="5"
      fill="#ffcc33"
      class="sun-core"
    ></circle>

    <!-- Sunlight ray to selected body -->
    <g class="sunlight" *ngIf="selectedDisplayPlanet as sdp">
      <line [attr.x1]="centerX" [attr.y1]="centerY" [attr.x2]="sdp.x" [attr.y2]="sdp.y" class="sun-ray"></line>
    </g>

    <!-- Orbits (2D) -->
    <g class="orbits" [attr.aria-label]="'aria.orbits' | t">
      <circle
        *ngFor="let p of planets"
        [attr.cx]="centerX"
        [attr.cy]="centerY"
        [attr.r]="getOrbitRadiusPx(p)"
        class="orbit-circle"
      ></circle>
    </g>

    <!-- Planets -->
    <g class="planets" [attr.aria-label]="'aria.planets' | t">
      <g
        *ngFor="let dp of displayPlanets; trackBy: trackByPlanetName"
        class="planet-group"
        [class.selected]="dp.isSelected"
        (click)="onPlanetClick(dp.planet); $event.stopPropagation()"
      >
        <circle
          [attr.cx]="dp.x"
          [attr.cy]="dp.y"
          [attr.r]="dp.radiusPx"
          [attr.fill]="'url(#planetGrad-' + dp.planet.name + ')'"
          class="planet-circle"
        ></circle>
        <circle
          [attr.cx]="dp.x"
          [attr.cy]="dp.y"
          [attr.r]="dp.radiusPx"
          [attr.fill]="'url(#planetTex-' + dp.planet.name + ')'"
          class="planet-texture"
          [attr.data-planet]="dp.planet.name"
        ></circle>
      </g>
    </g>

    <!-- Polar day/night indicators for selected planet -->
    <g class="poles" *ngIf="selectedDisplayPlanet as sdp">
      <g *ngIf="sdp.northPoleLit !== null && sdp.southPoleLit !== null">
        <circle
          [attr.cx]="sdp.x"
          [attr.cy]="sdp.y - sdp.radiusPx * selectedPlanetScale - 10"
          r="4.2"
          class="pole-dot"
          [class.lit]="sdp.northPoleLit"
          [class.dark]="!sdp.northPoleLit"
        ></circle>
        <text [attr.x]="sdp.x" [attr.y]="sdp.y - sdp.radiusPx * selectedPlanetScale - 7" class="pole-label">N</text>

        <circle
          [attr.cx]="sdp.x"
          [attr.cy]="sdp.y + sdp.radiusPx * selectedPlanetScale + 10"
          r="4.2"
          class="pole-dot"
          [class.lit]="sdp.southPoleLit"
          [class.dark]="!sdp.southPoleLit"
        ></circle>
        <text [attr.x]="sdp.x" [attr.y]="sdp.y + sdp.radiusPx * selectedPlanetScale + 13" class="pole-label">S</text>
      </g>
    </g>

    <!-- Satellites (only for focused planet) -->
    <g class="satellites" *ngIf="displaySatellites.length" [attr.aria-label]="'aria.satellites' | t">
      <g *ngFor="let s of displaySatellites; trackBy: trackByMoonId" (click)="onMoonClick(s.moon); $event.stopPropagation()">
        <circle [attr.cx]="s.x" [attr.cy]="s.y" r="2.6" class="sat-dot" [class.selected]="s.isSelected"></circle>
        <text *ngIf="s.isSelected" [attr.x]="s.x + 8" [attr.y]="s.y + 4" class="sat-label">
          {{ s.moon.displayName }}
        </text>
      </g>
    </g>
  </svg>

  <app-planet-info-panel
    *ngIf="selectedCatalogBody as body"
    [body]="body"
    [kind]="selectedKind"
    [ephemeris]="$any(selectedEphemeris)"
    [lighting]="selectedLighting"
    (close)="onCloseInfo()"
  ></app-planet-info-panel>
</div>
