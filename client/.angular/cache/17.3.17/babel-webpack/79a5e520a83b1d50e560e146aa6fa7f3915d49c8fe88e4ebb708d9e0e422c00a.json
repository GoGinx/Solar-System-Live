{"ast":null,"code":"import { animationFrames, catchError, forkJoin, interval, of, sampleTime, startWith, switchMap } from 'rxjs';\nimport * as i0 from \"@angular/core\";\nimport * as i1 from \"../../services/solar-system-catalog.service\";\nimport * as i2 from \"../../services/real-ephemeris.service\";\nimport * as i3 from \"../../services/time-scrubber.service\";\nimport * as i4 from \"@angular/common\";\nimport * as i5 from \"../planet-info-panel/planet-info-panel.component\";\nfunction SolarSystemComponent__svg_radialGradient_7_Template(rf, ctx) {\n  if (rf & 1) {\n    i0.ɵɵnamespaceSVG();\n    i0.ɵɵelementStart(0, \"radialGradient\", 17);\n    i0.ɵɵelement(1, \"stop\", 18)(2, \"stop\", 19)(3, \"stop\", 20)(4, \"stop\", 21);\n    i0.ɵɵelementEnd();\n  }\n  if (rf & 2) {\n    const dp_r1 = ctx.$implicit;\n    i0.ɵɵattribute(\"id\", \"planetGrad-\" + dp_r1.planet.name)(\"fx\", dp_r1.gradFx)(\"fy\", dp_r1.gradFy);\n    i0.ɵɵadvance();\n    i0.ɵɵattribute(\"stop-color\", dp_r1.lightColor);\n    i0.ɵɵadvance();\n    i0.ɵɵattribute(\"stop-color\", dp_r1.baseColor);\n    i0.ɵɵadvance();\n    i0.ɵɵattribute(\"stop-color\", dp_r1.planet.color);\n    i0.ɵɵadvance();\n    i0.ɵɵattribute(\"stop-color\", dp_r1.darkColor);\n  }\n}\nfunction SolarSystemComponent__svg_pattern_8_Template(rf, ctx) {\n  if (rf & 1) {\n    i0.ɵɵnamespaceSVG();\n    i0.ɵɵelementStart(0, \"pattern\", 22);\n    i0.ɵɵelement(1, \"image\", 23);\n    i0.ɵɵelementEnd();\n  }\n  if (rf & 2) {\n    const dp_r2 = ctx.$implicit;\n    i0.ɵɵattribute(\"id\", \"planetTex-\" + dp_r2.planet.name)(\"patternTransform\", \"rotate(\" + dp_r2.textureRotationDeg + \" 0.5 0.5)\");\n    i0.ɵɵadvance();\n    i0.ɵɵattribute(\"href\", dp_r2.textureUrl)(\"href\", dp_r2.textureUrl, null, \"xlink\");\n  }\n}\nfunction SolarSystemComponent__svg_g_10_Template(rf, ctx) {\n  if (rf & 1) {\n    i0.ɵɵnamespaceSVG();\n    i0.ɵɵelementStart(0, \"g\", 24);\n    i0.ɵɵelement(1, \"line\", 25);\n    i0.ɵɵelementEnd();\n  }\n  if (rf & 2) {\n    const sdp_r3 = ctx.ngIf;\n    const ctx_r3 = i0.ɵɵnextContext();\n    i0.ɵɵadvance();\n    i0.ɵɵattribute(\"x1\", ctx_r3.centerX)(\"y1\", ctx_r3.centerY)(\"x2\", sdp_r3.x)(\"y2\", sdp_r3.y);\n  }\n}\nfunction SolarSystemComponent__svg_circle_12_Template(rf, ctx) {\n  if (rf & 1) {\n    i0.ɵɵnamespaceSVG();\n    i0.ɵɵelement(0, \"circle\", 26);\n  }\n  if (rf & 2) {\n    const p_r5 = ctx.$implicit;\n    const ctx_r3 = i0.ɵɵnextContext();\n    i0.ɵɵattribute(\"cx\", ctx_r3.centerX)(\"cy\", ctx_r3.centerY)(\"r\", ctx_r3.getOrbitRadiusPx(p_r5));\n  }\n}\nfunction SolarSystemComponent__svg_g_14_Template(rf, ctx) {\n  if (rf & 1) {\n    const _r6 = i0.ɵɵgetCurrentView();\n    i0.ɵɵnamespaceSVG();\n    i0.ɵɵelementStart(0, \"g\", 27);\n    i0.ɵɵlistener(\"click\", function SolarSystemComponent__svg_g_14_Template_g_click_0_listener($event) {\n      const dp_r7 = i0.ɵɵrestoreView(_r6).$implicit;\n      const ctx_r3 = i0.ɵɵnextContext();\n      ctx_r3.onPlanetClick(dp_r7.planet);\n      return i0.ɵɵresetView($event.stopPropagation());\n    });\n    i0.ɵɵelement(1, \"circle\", 28)(2, \"circle\", 29);\n    i0.ɵɵelementEnd();\n  }\n  if (rf & 2) {\n    const dp_r7 = ctx.$implicit;\n    i0.ɵɵclassProp(\"selected\", dp_r7.isSelected);\n    i0.ɵɵadvance();\n    i0.ɵɵattribute(\"cx\", dp_r7.x)(\"cy\", dp_r7.y)(\"r\", dp_r7.radiusPx)(\"fill\", \"url(#planetGrad-\" + dp_r7.planet.name + \")\");\n    i0.ɵɵadvance();\n    i0.ɵɵattribute(\"cx\", dp_r7.x)(\"cy\", dp_r7.y)(\"r\", dp_r7.radiusPx)(\"fill\", \"url(#planetTex-\" + dp_r7.planet.name + \")\")(\"data-planet\", dp_r7.planet.name);\n  }\n}\nfunction SolarSystemComponent__svg_g_15__svg_g_1_Template(rf, ctx) {\n  if (rf & 1) {\n    i0.ɵɵnamespaceSVG();\n    i0.ɵɵelementStart(0, \"g\");\n    i0.ɵɵelement(1, \"circle\", 32);\n    i0.ɵɵelementStart(2, \"text\", 33);\n    i0.ɵɵtext(3, \"N\");\n    i0.ɵɵelementEnd();\n    i0.ɵɵelement(4, \"circle\", 32);\n    i0.ɵɵelementStart(5, \"text\", 33);\n    i0.ɵɵtext(6, \"S\");\n    i0.ɵɵelementEnd()();\n  }\n  if (rf & 2) {\n    const sdp_r8 = i0.ɵɵnextContext().ngIf;\n    const ctx_r3 = i0.ɵɵnextContext();\n    i0.ɵɵadvance();\n    i0.ɵɵclassProp(\"lit\", sdp_r8.northPoleLit)(\"dark\", !sdp_r8.northPoleLit);\n    i0.ɵɵattribute(\"cx\", sdp_r8.x)(\"cy\", sdp_r8.y - sdp_r8.radiusPx * ctx_r3.selectedPlanetScale - 10);\n    i0.ɵɵadvance();\n    i0.ɵɵattribute(\"x\", sdp_r8.x)(\"y\", sdp_r8.y - sdp_r8.radiusPx * ctx_r3.selectedPlanetScale - 7);\n    i0.ɵɵadvance(2);\n    i0.ɵɵclassProp(\"lit\", sdp_r8.southPoleLit)(\"dark\", !sdp_r8.southPoleLit);\n    i0.ɵɵattribute(\"cx\", sdp_r8.x)(\"cy\", sdp_r8.y + sdp_r8.radiusPx * ctx_r3.selectedPlanetScale + 10);\n    i0.ɵɵadvance();\n    i0.ɵɵattribute(\"x\", sdp_r8.x)(\"y\", sdp_r8.y + sdp_r8.radiusPx * ctx_r3.selectedPlanetScale + 13);\n  }\n}\nfunction SolarSystemComponent__svg_g_15_Template(rf, ctx) {\n  if (rf & 1) {\n    i0.ɵɵnamespaceSVG();\n    i0.ɵɵelementStart(0, \"g\", 30);\n    i0.ɵɵtemplate(1, SolarSystemComponent__svg_g_15__svg_g_1_Template, 7, 16, \"g\", 31);\n    i0.ɵɵelementEnd();\n  }\n  if (rf & 2) {\n    const sdp_r8 = ctx.ngIf;\n    i0.ɵɵadvance();\n    i0.ɵɵproperty(\"ngIf\", sdp_r8.northPoleLit !== null && sdp_r8.southPoleLit !== null);\n  }\n}\nfunction SolarSystemComponent__svg_g_16__svg_g_1__svg_text_2_Template(rf, ctx) {\n  if (rf & 1) {\n    i0.ɵɵnamespaceSVG();\n    i0.ɵɵelementStart(0, \"text\", 39);\n    i0.ɵɵtext(1);\n    i0.ɵɵelementEnd();\n  }\n  if (rf & 2) {\n    const s_r10 = i0.ɵɵnextContext().$implicit;\n    i0.ɵɵattribute(\"x\", s_r10.x + 8)(\"y\", s_r10.y + 4);\n    i0.ɵɵadvance();\n    i0.ɵɵtextInterpolate1(\" \", s_r10.moon.displayName, \" \");\n  }\n}\nfunction SolarSystemComponent__svg_g_16__svg_g_1_Template(rf, ctx) {\n  if (rf & 1) {\n    const _r9 = i0.ɵɵgetCurrentView();\n    i0.ɵɵnamespaceSVG();\n    i0.ɵɵelementStart(0, \"g\", 36);\n    i0.ɵɵlistener(\"click\", function SolarSystemComponent__svg_g_16__svg_g_1_Template_g_click_0_listener($event) {\n      const s_r10 = i0.ɵɵrestoreView(_r9).$implicit;\n      const ctx_r3 = i0.ɵɵnextContext(2);\n      ctx_r3.onMoonClick(s_r10.moon);\n      return i0.ɵɵresetView($event.stopPropagation());\n    });\n    i0.ɵɵelement(1, \"circle\", 37);\n    i0.ɵɵtemplate(2, SolarSystemComponent__svg_g_16__svg_g_1__svg_text_2_Template, 2, 3, \"text\", 38);\n    i0.ɵɵelementEnd();\n  }\n  if (rf & 2) {\n    const s_r10 = ctx.$implicit;\n    i0.ɵɵadvance();\n    i0.ɵɵclassProp(\"selected\", s_r10.isSelected);\n    i0.ɵɵattribute(\"cx\", s_r10.x)(\"cy\", s_r10.y);\n    i0.ɵɵadvance();\n    i0.ɵɵproperty(\"ngIf\", s_r10.isSelected);\n  }\n}\nfunction SolarSystemComponent__svg_g_16_Template(rf, ctx) {\n  if (rf & 1) {\n    i0.ɵɵnamespaceSVG();\n    i0.ɵɵelementStart(0, \"g\", 34);\n    i0.ɵɵtemplate(1, SolarSystemComponent__svg_g_16__svg_g_1_Template, 3, 5, \"g\", 35);\n    i0.ɵɵelementEnd();\n  }\n  if (rf & 2) {\n    const ctx_r3 = i0.ɵɵnextContext();\n    i0.ɵɵadvance();\n    i0.ɵɵproperty(\"ngForOf\", ctx_r3.displaySatellites)(\"ngForTrackBy\", ctx_r3.trackByMoonId);\n  }\n}\nfunction SolarSystemComponent_app_planet_info_panel_17_Template(rf, ctx) {\n  if (rf & 1) {\n    const _r11 = i0.ɵɵgetCurrentView();\n    i0.ɵɵelementStart(0, \"app-planet-info-panel\", 40);\n    i0.ɵɵlistener(\"close\", function SolarSystemComponent_app_planet_info_panel_17_Template_app_planet_info_panel_close_0_listener() {\n      i0.ɵɵrestoreView(_r11);\n      const ctx_r3 = i0.ɵɵnextContext();\n      return i0.ɵɵresetView(ctx_r3.onCloseInfo());\n    });\n    i0.ɵɵelementEnd();\n  }\n  if (rf & 2) {\n    const body_r12 = ctx.ngIf;\n    const ctx_r3 = i0.ɵɵnextContext();\n    i0.ɵɵproperty(\"body\", body_r12)(\"kindLabel\", ctx_r3.selectedKindLabel)(\"ephemeris\", ctx_r3.selectedEphemeris)(\"lighting\", ctx_r3.selectedLighting);\n  }\n}\nexport let SolarSystemComponent = /*#__PURE__*/(() => {\n  class SolarSystemComponent {\n    constructor(catalog, ephemerisService, time) {\n      this.catalog = catalog;\n      this.ephemerisService = ephemerisService;\n      this.time = time;\n      this.planets = [];\n      this.displayPlanets = [];\n      this.star = null;\n      this.focusedPlanet = null;\n      this.displaySatellites = [];\n      this.selected = null;\n      this.selectedEphemeris = null;\n      this.width = 800;\n      this.height = 800;\n      this.centerX = 400;\n      this.centerY = 400;\n      this.maxSemiMajorAxisAu = 30.1;\n      this.lastSnapshot = null;\n      this.offsetDays = 0;\n      this.nowMs = Date.now();\n      this.sunEphemerisRaw = null;\n      this.moonEphemerides = new Map();\n      this.planetStyleCache = new Map();\n      this.refreshIntervalMs = 60_000;\n      this.selectedPlanetScale = 2.1;\n      this.rotationEpochMs = Date.UTC(2025, 0, 1);\n      this.textureByPlanet = {\n        mercury: 'assets/textures/mercury.png',\n        venus: 'assets/textures/venus.png',\n        earth: 'assets/textures/earth.png',\n        mars: 'assets/textures/mars.png',\n        jupiter: 'assets/textures/jupiter.png',\n        saturn: 'assets/textures/saturn.png',\n        uranus: 'assets/textures/uranus.png',\n        neptune: 'assets/textures/neptune.png',\n        pluto: 'assets/textures/pluto.png'\n      };\n    }\n    trackByPlanetName(_, dp) {\n      return dp.planet.name;\n    }\n    trackByMoonId(_, s) {\n      return s.moon.id;\n    }\n    ngOnInit() {\n      this.catalogSub = this.catalog.getCatalog().subscribe({\n        next: c => {\n          this.star = c.star ?? null;\n          this.planets = c.planets ?? [];\n          this.maxSemiMajorAxisAu = this.planets.reduce((max, p) => p.semiMajorAxisAU > max ? p.semiMajorAxisAU : max, 0) || 30.1;\n          this.rebuildPlanetStyleCache();\n          this.refreshDisplay();\n          this.refreshSatellitesDisplay();\n        },\n        error: () => {\n          // Fallback: le composant peut fonctionner sans catalogue.\n        }\n      });\n      this.updateDimensionsFromWindow();\n      this.startPolling();\n      this.startAnimationLoop();\n      this.timeSub = this.time.offsetHours$.subscribe(h => {\n        this.offsetDays = h / 24;\n        this.refreshDisplay();\n        this.refreshSelectedEphemeris();\n        this.refreshSatellitesDisplay();\n      });\n    }\n    ngOnDestroy() {\n      this.sub?.unsubscribe();\n      this.sub = undefined;\n      this.catalogSub?.unsubscribe();\n      this.catalogSub = undefined;\n      this.sunSub?.unsubscribe();\n      this.sunSub = undefined;\n      this.moonsSub?.unsubscribe();\n      this.moonsSub = undefined;\n      this.timeSub?.unsubscribe();\n      this.timeSub = undefined;\n      this.frameSub?.unsubscribe();\n      this.frameSub = undefined;\n    }\n    onResize() {\n      this.updateDimensionsFromWindow();\n      this.refreshDisplay();\n      this.refreshSatellitesDisplay();\n    }\n    updateDimensionsFromWindow() {\n      this.width = Math.max(320, window.innerWidth);\n      this.height = Math.max(320, window.innerHeight);\n      this.centerX = this.width / 2;\n      this.centerY = this.height / 2;\n    }\n    startPolling() {\n      this.sub?.unsubscribe();\n      this.sub = interval(this.refreshIntervalMs).pipe(startWith(0), switchMap(() => this.ephemerisService.getCurrentPlanetPositions())).subscribe({\n        next: snapshot => {\n          this.lastSnapshot = snapshot;\n          this.refreshDisplay();\n          this.refreshSelectedEphemeris();\n          this.refreshSatellitesDisplay();\n        },\n        error: () => {\n          // On garde la derniere carte affichee si l'API tombe.\n        }\n      });\n    }\n    startAnimationLoop() {\n      this.frameSub?.unsubscribe();\n      this.frameSub = animationFrames().pipe(sampleTime(33)).subscribe(() => {\n        this.nowMs = Date.now();\n        this.refreshDisplay();\n        this.refreshSelectedEphemeris();\n        this.refreshSatellitesDisplay();\n      });\n    }\n    onSunClick() {\n      if (!this.star) return;\n      this.focusedPlanet = null;\n      this.displaySatellites = [];\n      this.moonEphemerides.clear();\n      this.moonsSub?.unsubscribe();\n      this.moonsSub = undefined;\n      this.sunEphemerisRaw = null;\n      this.selected = {\n        kind: 'star',\n        star: this.star\n      };\n      this.displayPlanets = this.displayPlanets.map(dp => ({\n        ...dp,\n        isSelected: false\n      }));\n      this.selectedEphemeris = null;\n      this.startSunPolling();\n    }\n    onPlanetClick(planet) {\n      this.stopSunPolling();\n      this.focusedPlanet = planet;\n      this.selected = {\n        kind: 'planet',\n        planet\n      };\n      this.selectedEphemeris = null;\n      this.refreshSelectedEphemeris();\n      this.startMoonsPollingForFocusedPlanet();\n      this.displayPlanets = this.displayPlanets.map(dp => ({\n        ...dp,\n        isSelected: dp.planet.name === planet.name\n      }));\n    }\n    onMoonClick(moon) {\n      if (!this.focusedPlanet) return;\n      this.stopSunPolling();\n      this.selected = {\n        kind: 'moon',\n        planet: this.focusedPlanet,\n        moon\n      };\n      this.refreshSelectedEphemeris();\n      this.refreshSatellitesDisplay();\n    }\n    onCloseInfo() {\n      this.selected = null;\n      this.selectedEphemeris = null;\n      this.focusedPlanet = null;\n      this.displaySatellites = [];\n      this.moonEphemerides.clear();\n      this.sunEphemerisRaw = null;\n      this.stopSunPolling();\n      this.moonsSub?.unsubscribe();\n      this.moonsSub = undefined;\n      this.displayPlanets = this.displayPlanets.map(dp => ({\n        ...dp,\n        isSelected: false\n      }));\n    }\n    get selectedCatalogBody() {\n      if (!this.selected) return null;\n      if (this.selected.kind === 'planet') return this.selected.planet;\n      if (this.selected.kind === 'moon') return this.selected.moon;\n      return this.selected.star;\n    }\n    get selectedKindLabel() {\n      if (!this.selected) return '';\n      if (this.selected.kind === 'planet') return 'Planete';\n      if (this.selected.kind === 'moon') return 'Satellite';\n      return 'Etoile';\n    }\n    get selectedDisplayPlanet() {\n      if (!this.selected) return null;\n      if (this.selected.kind === 'star') return null;\n      return this.displayPlanets.find(dp => dp.planet.name === this.selected.planet.name) ?? null;\n    }\n    get selectedLighting() {\n      if (this.selected?.kind !== 'planet') return null;\n      const dp = this.selectedDisplayPlanet;\n      if (!dp) return null;\n      return {\n        subsolarLatitudeDeg: dp.subsolarLatitudeDeg,\n        northPoleLit: dp.northPoleLit,\n        southPoleLit: dp.southPoleLit\n      };\n    }\n    getOrbitRadiusPx(planet) {\n      return this.distanceToPixels(planet.semiMajorAxisAU);\n    }\n    planetRadiusToPixels(planet) {\n      const minPx = 3.2;\n      const maxPx = 14;\n      const log = Math.log10(planet.radiusKm);\n      const logMin = Math.log10(1188.3); // Pluton\n      const logMax = Math.log10(69911); // Jupiter\n      const t = (log - logMin) / (logMax - logMin);\n      return minPx + Math.max(0, Math.min(1, t)) * (maxPx - minPx);\n    }\n    distanceToPixels(distanceAu) {\n      const maxRadiusPx = Math.min(this.width, this.height) / 2 - 40;\n      const clamped = Math.max(0, Math.min(distanceAu, this.maxSemiMajorAxisAu));\n      const normalized = Math.log10(1 + clamped) / Math.log10(1 + Math.max(1e-6, this.maxSemiMajorAxisAu));\n      return normalized * maxRadiusPx;\n    }\n    refreshDisplay() {\n      if (!this.lastSnapshot) {\n        this.displayPlanets = this.planets.map(p => {\n          const style = this.getPlanetStyle(p);\n          return {\n            planet: p,\n            x: this.centerX,\n            y: this.centerY,\n            radiusPx: this.planetRadiusToPixels(p),\n            textureRotationDeg: this.computeTextureRotationDeg(p),\n            textureUrl: style.textureUrl,\n            sunDirX: 0,\n            sunDirY: 0,\n            gradFx: '50%',\n            gradFy: '50%',\n            lightColor: style.lightColor,\n            baseColor: style.baseColor,\n            darkColor: style.darkColor,\n            subsolarLatitudeDeg: null,\n            northPoleLit: null,\n            southPoleLit: null,\n            isSelected: this.selected?.kind === 'planet' && this.selected.planet.name === p.name || this.selected?.kind === 'moon' && this.selected.planet.name === p.name\n          };\n        });\n        return;\n      }\n      const positions = new Map();\n      for (const b of this.lastSnapshot.bodies) {\n        positions.set(b.name, b);\n      }\n      this.displayPlanets = this.planets.map(planet => {\n        const pos = positions.get(planet.name);\n        const style = this.getPlanetStyle(planet);\n        if (!pos) {\n          return {\n            planet,\n            x: this.centerX,\n            y: this.centerY,\n            radiusPx: this.planetRadiusToPixels(planet),\n            textureRotationDeg: this.computeTextureRotationDeg(planet),\n            textureUrl: style.textureUrl,\n            sunDirX: 0,\n            sunDirY: 0,\n            gradFx: '50%',\n            gradFy: '50%',\n            lightColor: style.lightColor,\n            baseColor: style.baseColor,\n            darkColor: style.darkColor,\n            subsolarLatitudeDeg: null,\n            northPoleLit: null,\n            southPoleLit: null,\n            isSelected: this.selected?.kind === 'planet' && this.selected.planet.name === planet.name || this.selected?.kind === 'moon' && this.selected.planet.name === planet.name\n          };\n        }\n        const {\n          x,\n          y,\n          z\n        } = this.advanceStateVector(pos, pos.timestamp || this.lastSnapshot?.timestamp);\n        const rAu = Math.sqrt(x * x + y * y + z * z) || 1e-6;\n        const angle = Math.atan2(y, x);\n        const rPx = this.distanceToPixels(rAu);\n        const screenX = this.centerX + rPx * Math.cos(angle);\n        const screenY = this.centerY + rPx * Math.sin(angle);\n        const radiusPx = this.planetRadiusToPixels(planet);\n        const sunDx = this.centerX - screenX;\n        const sunDy = this.centerY - screenY;\n        const sunLen = Math.sqrt(sunDx * sunDx + sunDy * sunDy) || 1e-9;\n        const sunDirX = sunDx / sunLen;\n        const sunDirY = sunDy / sunLen;\n        const gradFx = `${(this.clamp01(0.5 + sunDirX * 0.33) * 100).toFixed(1)}%`;\n        const gradFy = `${(this.clamp01(0.5 + sunDirY * 0.33) * 100).toFixed(1)}%`;\n        const lighting = this.computePlanetPoleLighting(planet, {\n          x_au: x,\n          y_au: y,\n          z_au: z\n        });\n        return {\n          planet,\n          x: screenX,\n          y: screenY,\n          radiusPx,\n          textureRotationDeg: this.computeTextureRotationDeg(planet),\n          textureUrl: style.textureUrl,\n          sunDirX,\n          sunDirY,\n          gradFx,\n          gradFy,\n          lightColor: style.lightColor,\n          baseColor: style.baseColor,\n          darkColor: style.darkColor,\n          subsolarLatitudeDeg: lighting?.subsolarLatitudeDeg ?? null,\n          northPoleLit: lighting?.northPoleLit ?? null,\n          southPoleLit: lighting?.southPoleLit ?? null,\n          isSelected: this.selected?.kind === 'planet' && this.selected.planet.name === planet.name || this.selected?.kind === 'moon' && this.selected.planet.name === planet.name\n        };\n      });\n    }\n    refreshSelectedEphemeris() {\n      if (!this.selected) {\n        this.selectedEphemeris = null;\n        return;\n      }\n      if (this.selected.kind === 'planet') {\n        if (!this.lastSnapshot) {\n          this.selectedEphemeris = null;\n          return;\n        }\n        const ephem = this.lastSnapshot.bodies.find(b => b.name === this.selected.planet.name) ?? null;\n        if (!ephem) {\n          this.selectedEphemeris = null;\n          return;\n        }\n        const advanced = this.advanceStateVector(ephem, ephem.timestamp || this.lastSnapshot.timestamp);\n        const baseTs = Date.parse(ephem.timestamp || this.lastSnapshot.timestamp || '');\n        const ts = Number.isFinite(baseTs) ? new Date(baseTs + this.effectiveDaysFromTimestamp(ephem.timestamp || this.lastSnapshot.timestamp) * 86_400_000).toISOString() : ephem.timestamp;\n        this.selectedEphemeris = {\n          ...ephem,\n          x_au: advanced.x,\n          y_au: advanced.y,\n          z_au: advanced.z,\n          timestamp: ts\n        };\n        return;\n      }\n      if (this.selected.kind === 'moon') {\n        const raw = this.moonEphemerides.get(this.selected.moon.id) ?? null;\n        this.selectedEphemeris = raw ? this.adjustBodyEphemeris(raw) : null;\n        return;\n      }\n      if (this.selected.kind === 'star') {\n        this.selectedEphemeris = this.sunEphemerisRaw ? this.adjustBodyEphemeris(this.sunEphemerisRaw) : null;\n        return;\n      }\n    }\n    startSunPolling() {\n      this.stopSunPolling();\n      this.sunSub = interval(this.refreshIntervalMs).pipe(startWith(0), switchMap(() => this.ephemerisService.getBodyEphemeris('sun'))).subscribe({\n        next: payload => {\n          if (this.selected?.kind !== 'star') return;\n          this.sunEphemerisRaw = payload;\n          this.selectedEphemeris = this.adjustBodyEphemeris(payload);\n        },\n        error: () => {\n          // Pas bloquant.\n        }\n      });\n    }\n    stopSunPolling() {\n      this.sunSub?.unsubscribe();\n      this.sunSub = undefined;\n    }\n    startMoonsPollingForFocusedPlanet() {\n      const planet = this.focusedPlanet;\n      const moons = planet?.moons ?? [];\n      this.moonsSub?.unsubscribe();\n      this.moonsSub = undefined;\n      this.moonEphemerides.clear();\n      this.displaySatellites = [];\n      if (!planet || moons.length === 0) {\n        return;\n      }\n      this.moonsSub = interval(this.refreshIntervalMs).pipe(startWith(0), switchMap(() => forkJoin(moons.map(m => this.ephemerisService.getBodyEphemeris(m.id).pipe(catchError(() => of(null))))))).subscribe({\n        next: results => {\n          for (const payload of results) {\n            if (!payload) continue;\n            this.moonEphemerides.set(payload.id, payload);\n          }\n          this.refreshSatellitesDisplay();\n          if (this.selected?.kind === 'moon') {\n            this.refreshSelectedEphemeris();\n          }\n        },\n        error: () => {\n          // Pas bloquant.\n        }\n      });\n    }\n    refreshSatellitesDisplay() {\n      const planet = this.focusedPlanet;\n      if (!planet || !this.lastSnapshot) {\n        this.displaySatellites = [];\n        return;\n      }\n      const planetEphem = this.lastSnapshot.bodies.find(b => b.name === planet.name) ?? null;\n      if (!planetEphem) {\n        this.displaySatellites = [];\n        return;\n      }\n      const dp = this.displayPlanets.find(d => d.planet.name === planet.name) ?? null;\n      if (!dp) {\n        this.displaySatellites = [];\n        return;\n      }\n      const advancedPlanet = this.advanceStateVector(planetEphem, planetEphem.timestamp || this.lastSnapshot.timestamp);\n      const planetX = advancedPlanet.x;\n      const planetY = advancedPlanet.y;\n      const planetZ = advancedPlanet.z;\n      const moons = planet.moons ?? [];\n      if (moons.length === 0) {\n        this.displaySatellites = [];\n        return;\n      }\n      this.displaySatellites = moons.map((moon, idx) => {\n        const raw = this.moonEphemerides.get(moon.id);\n        if (!raw) return null;\n        const m = this.adjustBodyEphemeris(raw);\n        const dx = m.x_au - planetX;\n        const dy = m.y_au - planetY;\n        const dz = m.z_au - planetZ;\n        const dist = Math.sqrt(dx * dx + dy * dy + dz * dz) || 1e-9;\n        const angle = Math.atan2(dy, dx);\n        const planetR = this.planetRadiusToPixels(planet);\n        const extra = Math.min(30, Math.max(8, Math.log10(1 + dist * 20_000) * 8));\n        const offsetPx = planetR + 8 + extra + idx % 3 * 1.5;\n        return {\n          moon,\n          x: dp.x + offsetPx * Math.cos(angle),\n          y: dp.y + offsetPx * Math.sin(angle),\n          isSelected: this.selected?.kind === 'moon' && this.selected.moon.id === moon.id\n        };\n      }).filter(v => !!v);\n    }\n    adjustBodyEphemeris(ephem) {\n      const {\n        x,\n        y,\n        z\n      } = this.advanceStateVector(ephem, ephem.timestamp);\n      const baseTs = Date.parse(ephem.timestamp || '');\n      const ts = Number.isFinite(baseTs) ? new Date(baseTs + this.effectiveDaysFromTimestamp(ephem.timestamp) * 86_400_000).toISOString() : ephem.timestamp;\n      return {\n        ...ephem,\n        x_au: x,\n        y_au: y,\n        z_au: z,\n        timestamp: ts\n      };\n    }\n    advanceStateVector(vec, timestampIso) {\n      const days = this.effectiveDaysFromTimestamp(timestampIso);\n      const x = vec.vx !== undefined ? vec.x_au + vec.vx * days : vec.x_au;\n      const y = vec.vy !== undefined ? vec.y_au + vec.vy * days : vec.y_au;\n      const z = vec.vz !== undefined ? vec.z_au + vec.vz * days : vec.z_au;\n      return {\n        x,\n        y,\n        z\n      };\n    }\n    effectiveDaysFromTimestamp(timestampIso) {\n      const baseTs = Date.parse(timestampIso || '');\n      const liveDays = Number.isFinite(baseTs) ? (this.nowMs - baseTs) / 86_400_000 : 0;\n      return this.offsetDays + liveDays;\n    }\n    clamp01(v) {\n      return Math.max(0, Math.min(1, v));\n    }\n    computeTextureRotationDeg(planet) {\n      const periodHours = planet.rotationPeriodHours ?? 24;\n      const periodMs = Math.abs(periodHours) * 3_600_000;\n      if (!Number.isFinite(periodMs) || periodMs <= 0) return 0;\n      const direction = periodHours < 0 ? -1 : 1;\n      const deltaMs = this.nowMs - this.rotationEpochMs + this.offsetDays * 86_400_000;\n      const phase = (deltaMs % periodMs + periodMs) % periodMs;\n      return phase / periodMs * 360 * direction;\n    }\n    parseHexColor(hex) {\n      const raw = hex.trim();\n      const m = /^#([0-9a-f]{6}|[0-9a-f]{3})$/i.exec(raw);\n      if (!m) return null;\n      const v = m[1];\n      if (v.length === 3) {\n        const r = parseInt(v[0] + v[0], 16);\n        const g = parseInt(v[1] + v[1], 16);\n        const b = parseInt(v[2] + v[2], 16);\n        return {\n          r,\n          g,\n          b\n        };\n      }\n      const r = parseInt(v.slice(0, 2), 16);\n      const g = parseInt(v.slice(2, 4), 16);\n      const b = parseInt(v.slice(4, 6), 16);\n      return {\n        r,\n        g,\n        b\n      };\n    }\n    mixColor(color, target, t) {\n      const a = this.parseHexColor(color);\n      const b = this.parseHexColor(target);\n      if (!a || !b) return color;\n      const tt = this.clamp01(t);\n      const r = Math.round(a.r + (b.r - a.r) * tt);\n      const g = Math.round(a.g + (b.g - a.g) * tt);\n      const bb = Math.round(a.b + (b.b - a.b) * tt);\n      return `rgb(${r}, ${g}, ${bb})`;\n    }\n    rebuildPlanetStyleCache() {\n      this.planetStyleCache.clear();\n      for (const planet of this.planets) {\n        this.planetStyleCache.set(planet.name, {\n          textureUrl: this.textureByPlanet[planet.name],\n          lightColor: this.mixColor(planet.color, '#ffffff', 0.55),\n          baseColor: this.mixColor(planet.color, '#ffffff', 0.08),\n          darkColor: this.mixColor(planet.color, '#000000', 0.72)\n        });\n      }\n    }\n    getPlanetStyle(planet) {\n      return this.planetStyleCache.get(planet.name) ?? {\n        textureUrl: this.textureByPlanet[planet.name],\n        lightColor: this.mixColor(planet.color, '#ffffff', 0.55),\n        baseColor: this.mixColor(planet.color, '#ffffff', 0.08),\n        darkColor: this.mixColor(planet.color, '#000000', 0.72)\n      };\n    }\n    computePlanetPoleLighting(planet, pos) {\n      const tilt = planet.axialTiltDeg;\n      if (tilt === undefined || tilt === null || !Number.isFinite(tilt)) return null;\n      const effectiveTilt = tilt <= 90 ? tilt : 180 - tilt;\n      const lambda = Math.atan2(pos.y_au, pos.x_au);\n      const subsolarLatitudeDeg = effectiveTilt * Math.sin(lambda);\n      const eps = 1e-9;\n      return {\n        subsolarLatitudeDeg,\n        northPoleLit: subsolarLatitudeDeg > eps,\n        southPoleLit: subsolarLatitudeDeg < -eps\n      };\n    }\n    static {\n      this.ɵfac = function SolarSystemComponent_Factory(t) {\n        return new (t || SolarSystemComponent)(i0.ɵɵdirectiveInject(i1.SolarSystemCatalogService), i0.ɵɵdirectiveInject(i2.RealEphemerisService), i0.ɵɵdirectiveInject(i3.TimeScrubberService));\n      };\n    }\n    static {\n      this.ɵcmp = /*@__PURE__*/i0.ɵɵdefineComponent({\n        type: SolarSystemComponent,\n        selectors: [[\"app-solar-system\"]],\n        hostBindings: function SolarSystemComponent_HostBindings(rf, ctx) {\n          if (rf & 1) {\n            i0.ɵɵlistener(\"resize\", function SolarSystemComponent_resize_HostBindingHandler() {\n              return ctx.onResize();\n            }, false, i0.ɵɵresolveWindow);\n          }\n        },\n        decls: 18,\n        vars: 19,\n        consts: [[1, \"space-stage\"], [\"role\", \"img\", \"aria-label\", \"Carte du systeme solaire (live)\", 1, \"solar-system-svg\"], [\"id\", \"sunGradient\"], [\"offset\", \"0%\", \"stop-color\", \"#ffffdd\"], [\"offset\", \"70%\", \"stop-color\", \"#ffcc33\"], [\"offset\", \"100%\", \"stop-color\", \"#dd8800\"], [\"cx\", \"50%\", \"cy\", \"50%\", \"r\", \"80%\", 4, \"ngFor\", \"ngForOf\", \"ngForTrackBy\"], [\"patternUnits\", \"objectBoundingBox\", \"patternContentUnits\", \"objectBoundingBox\", \"width\", \"1\", \"height\", \"1\", 4, \"ngFor\", \"ngForOf\", \"ngForTrackBy\"], [\"fill\", \"url(#sunGradient)\", 1, \"sun\", \"sun-clickable\", 3, \"click\"], [\"class\", \"sunlight\", 4, \"ngIf\"], [\"aria-label\", \"Orbits\", 1, \"orbits\"], [\"class\", \"orbit-circle\", 4, \"ngFor\", \"ngForOf\"], [\"aria-label\", \"Planets\", 1, \"planets\"], [\"class\", \"planet-group\", 3, \"selected\", \"click\", 4, \"ngFor\", \"ngForOf\", \"ngForTrackBy\"], [\"class\", \"poles\", 4, \"ngIf\"], [\"class\", \"satellites\", \"aria-label\", \"Satellites\", 4, \"ngIf\"], [3, \"body\", \"kindLabel\", \"ephemeris\", \"lighting\", \"close\", 4, \"ngIf\"], [\"cx\", \"50%\", \"cy\", \"50%\", \"r\", \"80%\"], [\"offset\", \"0%\", \"stop-opacity\", \"1\"], [\"offset\", \"52%\", \"stop-opacity\", \"1\"], [\"offset\", \"78%\", \"stop-opacity\", \"1\"], [\"offset\", \"100%\", \"stop-opacity\", \"1\"], [\"patternUnits\", \"objectBoundingBox\", \"patternContentUnits\", \"objectBoundingBox\", \"width\", \"1\", \"height\", \"1\"], [\"x\", \"0\", \"y\", \"0\", \"width\", \"1\", \"height\", \"1\", \"preserveAspectRatio\", \"xMidYMid slice\"], [1, \"sunlight\"], [1, \"sun-ray\"], [1, \"orbit-circle\"], [1, \"planet-group\", 3, \"click\"], [1, \"planet-circle\"], [1, \"planet-texture\"], [1, \"poles\"], [4, \"ngIf\"], [\"r\", \"4.2\", 1, \"pole-dot\"], [1, \"pole-label\"], [\"aria-label\", \"Satellites\", 1, \"satellites\"], [3, \"click\", 4, \"ngFor\", \"ngForOf\", \"ngForTrackBy\"], [3, \"click\"], [\"r\", \"2.6\", 1, \"sat-dot\"], [\"class\", \"sat-label\", 4, \"ngIf\"], [1, \"sat-label\"], [3, \"close\", \"body\", \"kindLabel\", \"ephemeris\", \"lighting\"]],\n        template: function SolarSystemComponent_Template(rf, ctx) {\n          if (rf & 1) {\n            i0.ɵɵelementStart(0, \"div\", 0);\n            i0.ɵɵnamespaceSVG();\n            i0.ɵɵelementStart(1, \"svg\", 1)(2, \"defs\")(3, \"radialGradient\", 2);\n            i0.ɵɵelement(4, \"stop\", 3)(5, \"stop\", 4)(6, \"stop\", 5);\n            i0.ɵɵelementEnd();\n            i0.ɵɵtemplate(7, SolarSystemComponent__svg_radialGradient_7_Template, 5, 7, \"radialGradient\", 6)(8, SolarSystemComponent__svg_pattern_8_Template, 2, 4, \"pattern\", 7);\n            i0.ɵɵelementEnd();\n            i0.ɵɵelementStart(9, \"circle\", 8);\n            i0.ɵɵlistener(\"click\", function SolarSystemComponent_Template_circle_click_9_listener($event) {\n              ctx.onSunClick();\n              return $event.stopPropagation();\n            });\n            i0.ɵɵelementEnd();\n            i0.ɵɵtemplate(10, SolarSystemComponent__svg_g_10_Template, 2, 4, \"g\", 9);\n            i0.ɵɵelementStart(11, \"g\", 10);\n            i0.ɵɵtemplate(12, SolarSystemComponent__svg_circle_12_Template, 1, 3, \"circle\", 11);\n            i0.ɵɵelementEnd();\n            i0.ɵɵelementStart(13, \"g\", 12);\n            i0.ɵɵtemplate(14, SolarSystemComponent__svg_g_14_Template, 3, 11, \"g\", 13);\n            i0.ɵɵelementEnd();\n            i0.ɵɵtemplate(15, SolarSystemComponent__svg_g_15_Template, 2, 1, \"g\", 14)(16, SolarSystemComponent__svg_g_16_Template, 2, 2, \"g\", 15);\n            i0.ɵɵelementEnd();\n            i0.ɵɵtemplate(17, SolarSystemComponent_app_planet_info_panel_17_Template, 1, 4, \"app-planet-info-panel\", 16);\n            i0.ɵɵelementEnd();\n          }\n          if (rf & 2) {\n            i0.ɵɵstyleProp(\"--selected-planet-scale\", ctx.selectedPlanetScale);\n            i0.ɵɵadvance();\n            i0.ɵɵattribute(\"width\", ctx.width)(\"height\", ctx.height)(\"viewBox\", \"0 0 \" + ctx.width + \" \" + ctx.height);\n            i0.ɵɵadvance(6);\n            i0.ɵɵproperty(\"ngForOf\", ctx.displayPlanets)(\"ngForTrackBy\", ctx.trackByPlanetName);\n            i0.ɵɵadvance();\n            i0.ɵɵproperty(\"ngForOf\", ctx.displayPlanets)(\"ngForTrackBy\", ctx.trackByPlanetName);\n            i0.ɵɵadvance();\n            i0.ɵɵattribute(\"cx\", ctx.centerX)(\"cy\", ctx.centerY)(\"r\", 14);\n            i0.ɵɵadvance();\n            i0.ɵɵproperty(\"ngIf\", ctx.selectedDisplayPlanet);\n            i0.ɵɵadvance(2);\n            i0.ɵɵproperty(\"ngForOf\", ctx.planets);\n            i0.ɵɵadvance(2);\n            i0.ɵɵproperty(\"ngForOf\", ctx.displayPlanets)(\"ngForTrackBy\", ctx.trackByPlanetName);\n            i0.ɵɵadvance();\n            i0.ɵɵproperty(\"ngIf\", ctx.selectedDisplayPlanet);\n            i0.ɵɵadvance();\n            i0.ɵɵproperty(\"ngIf\", ctx.displaySatellites.length);\n            i0.ɵɵadvance();\n            i0.ɵɵproperty(\"ngIf\", ctx.selectedCatalogBody);\n          }\n        },\n        dependencies: [i4.NgForOf, i4.NgIf, i5.PlanetInfoPanelComponent],\n        styles: [\"[_nghost-%COMP%]{display:block;width:100vw;height:100vh;overflow:hidden;background:radial-gradient(circle at 50% 40%,#060a22,#03040c 45%,#000);color:#eaf0ff}.space-stage[_ngcontent-%COMP%]{position:relative;width:100%;height:100%}.space-stage[_ngcontent-%COMP%]:before{content:\\\"\\\";position:absolute;inset:0;pointer-events:none;background:radial-gradient(circle at 20% 30%,rgba(88,101,242,.08),transparent 45%),radial-gradient(circle at 70% 60%,rgba(0,255,240,.05),transparent 42%),radial-gradient(circle at 40% 80%,rgba(255,0,128,.04),transparent 50%),radial-gradient(circle at 12% 18%,rgba(255,255,255,.22) 0 1px,transparent 2px),radial-gradient(circle at 33% 72%,rgba(255,255,255,.18) 0 1px,transparent 2px),radial-gradient(circle at 82% 35%,rgba(255,255,255,.16) 0 1px,transparent 2px),radial-gradient(circle at 58% 18%,rgba(255,255,255,.14) 0 1px,transparent 2px),radial-gradient(circle at 66% 88%,rgba(255,255,255,.12) 0 1px,transparent 2px);filter:blur(.2px);opacity:.95}.space-stage[_ngcontent-%COMP%]:after{content:\\\"\\\";position:absolute;inset:-2px;pointer-events:none;background:repeating-linear-gradient(to bottom,#ffffff05 0px 1px,#0000 3px 6px),repeating-linear-gradient(90deg,#00fff009 0px 1px,#0000 60px 120px);mix-blend-mode:screen;opacity:.35}.solar-system-svg[_ngcontent-%COMP%]{width:100%;height:100%;display:block;-webkit-user-select:none;user-select:none;-webkit-tap-highlight-color:transparent}.sun[_ngcontent-%COMP%]{filter:drop-shadow(0 0 18px rgba(255,204,51,.75))}.sun-clickable[_ngcontent-%COMP%]{cursor:pointer}.sun-clickable[_ngcontent-%COMP%]:hover{filter:drop-shadow(0 0 18px rgba(255,204,51,.78)) drop-shadow(0 0 28px rgba(255,204,51,.35))}.orbits[_ngcontent-%COMP%], .sunlight[_ngcontent-%COMP%]{pointer-events:none}.sun-ray[_ngcontent-%COMP%]{stroke:#ffcc3340;stroke-width:1.2;stroke-dasharray:4 7;filter:drop-shadow(0 0 10px rgba(255,204,51,.22)) drop-shadow(0 0 22px rgba(0,255,240,.08));opacity:.9}.orbit-circle[_ngcontent-%COMP%]{fill:none;stroke:#00fff01f;stroke-width:1;stroke-dasharray:2 6;filter:drop-shadow(0 0 6px rgba(0,255,240,.12))}.planets[_ngcontent-%COMP%]{cursor:default}.planet-group[_ngcontent-%COMP%]{cursor:pointer;transition:transform .12s ease-out;transform-origin:center center;transform-box:fill-box}.planet-group[_ngcontent-%COMP%]:hover{transform:scale(1.08)}.planet-group.selected[_ngcontent-%COMP%]{transform:scale(var(--selected-planet-scale, 2.1))}.planet-group.selected[_ngcontent-%COMP%]:hover{transform:scale(calc(var(--selected-planet-scale, 2.1) + .1))}.planet-circle[_ngcontent-%COMP%]{cursor:pointer;stroke:#ffffffd9;stroke-width:.6;transition:filter .12s ease-out,stroke-width .12s ease-out;transform-origin:center center}.planet-group[_ngcontent-%COMP%]:hover   .planet-circle[_ngcontent-%COMP%]{stroke-width:1.1;filter:drop-shadow(0 0 10px rgba(0,255,240,.45))}.planet-group.selected[_ngcontent-%COMP%]   .planet-circle[_ngcontent-%COMP%]{stroke-width:1.6;filter:drop-shadow(0 0 10px rgba(0,255,240,.55)) drop-shadow(0 0 22px rgba(88,101,242,.35))}.planet-texture[_ngcontent-%COMP%]{pointer-events:none;opacity:.5;mix-blend-mode:soft-light;filter:saturate(.98) contrast(.98)}.planet-texture[data-planet=mercury][_ngcontent-%COMP%], .planet-texture[data-planet=venus][_ngcontent-%COMP%], .planet-texture[data-planet=earth][_ngcontent-%COMP%], .planet-texture[data-planet=mars][_ngcontent-%COMP%], .planet-texture[data-planet=pluto][_ngcontent-%COMP%]{opacity:.62;mix-blend-mode:soft-light;filter:saturate(1) contrast(1)}.planet-texture[data-planet=jupiter][_ngcontent-%COMP%], .planet-texture[data-planet=saturn][_ngcontent-%COMP%], .planet-texture[data-planet=uranus][_ngcontent-%COMP%], .planet-texture[data-planet=neptune][_ngcontent-%COMP%]{opacity:.48;mix-blend-mode:soft-light;filter:saturate(1.05) contrast(.95)}.poles[_ngcontent-%COMP%]{pointer-events:none}.pole-dot[_ngcontent-%COMP%]{stroke:#ffffffad;stroke-width:.8}.pole-dot.lit[_ngcontent-%COMP%]{fill:#ffffffeb;filter:drop-shadow(0 0 10px rgba(255,204,51,.28))}.pole-dot.dark[_ngcontent-%COMP%]{fill:#000000d6;filter:drop-shadow(0 0 10px rgba(255,0,128,.22)) drop-shadow(0 0 18px rgba(88,101,242,.16))}.pole-label[_ngcontent-%COMP%]{fill:#eef2ffeb;font-size:9.5px;font-weight:900;text-anchor:middle;paint-order:stroke;stroke:#000000d9;stroke-width:3px}.satellites[_ngcontent-%COMP%]{cursor:pointer}.sat-dot[_ngcontent-%COMP%]{fill:#00fff0e6;stroke:#ffffffbf;stroke-width:.6;filter:drop-shadow(0 0 12px rgba(0,255,240,.45))}.sat-dot.selected[_ngcontent-%COMP%]{fill:#ff0080eb;filter:drop-shadow(0 0 12px rgba(255,0,128,.42)) drop-shadow(0 0 24px rgba(88,101,242,.28))}.sat-label[_ngcontent-%COMP%]{fill:#eef2ffe6;font-size:11px;font-weight:800;letter-spacing:.04em;paint-order:stroke;stroke:#000000d9;stroke-width:3px}.space-stage[_ngcontent-%COMP%]   app-planet-info-panel[_ngcontent-%COMP%]{position:absolute;right:22px;bottom:22px;z-index:10;max-width:min(420px,calc(100vw - 44px))}\"]\n      });\n    }\n  }\n  return SolarSystemComponent;\n})();","map":null,"metadata":{},"sourceType":"module","externalDependencies":[]}